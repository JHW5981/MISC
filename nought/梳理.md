<h1><font face="黑体" size=10 color=white>2024.2.26 Nougat/train.py</font></h1>
<font face="宋体" size=5 color=white>
<ul>
    <li>主要部分是`train`函数，这个函数只有一个参数，`cfg`，所有内容定义在`cfg`中，把`cfg`传给`train`就可以直接训练，值得学习
    </li>
    <li>`train`中先设置随机种子，然后定义模型和数据集，再定义各种回调函数，包括学习率回调、checkpoint回调、自定义的梯度监测回调。然后就是logger，接着就是使用lightning.pytorch中的训练框架，进行定义及训练
    </li>
    <li>细节部分就是各种自定义的回调函数如何定义以及各种接口如何使用的。这个是需要好好研究的部分。
    </li>
</ul>
</font>

<h1><font face="黑体" size=10 color=white>2024.2.27 Nougat/test.py</font></h1>
<font face="宋体" size=5 color=white>
<ul>
    <li>`test.py`中只有一个函数test，入口是args，返回模型预测的结果。</li>
    <li>先定义了模型，导入checkpoint，将模型设置为`eval`模式，接着make test结果的文件夹，然后准备数据集，dataloader，然后就是for循环里依次将每个batch喂到模型里，将产生的结果送到get_metric函数计算指标，保存指标，返回预测结果。</li>
    <li>里面有个多线程并行的内容值的学习一下，Pool池去做的，写在csdn中了，但是我实验出来并行花的时间更多不知道什么情况。</li>
</ul>
</font>


<h1><font face="黑体" size=10 color=white>2024.2.27 Nougat/predict.py</font></h1>
<font face="宋体" size=5 color=white>
<ul>
    <li>`predict.py`先导入模型，将模型设置成eval模式，再准备dataset，准备dataloader，dataset是每个pdf用一个LazyDataset进行定义，然后append到datasets里，用ConcatDataset合成一个。然后进行inference，然后对模型结果进行处理保存。</li>
</ul>
</font>


<h1><font face="黑体" size=10 color=white>2024.2.27 Nougat/lightning_module.py</font></h1>
<font face="宋体" size=5 color=white>
<ul>
    <li>这个文件非常重要，定义了使用pytorch ligntning训练所需的Model Module和Data Module</li>
    <li>`NougatModelPLModule`类继承自`pl.LightningModule`，初始化中定义了模型。<br>
    接下来是内置函数`training_step`的重写，定义了模型训练时的行为，做法就是把batch的数据取出来，通过模型获得loss，最后也返回loss。
    <br>
    然后是`validation_step`的重写，读取batch中的数据，使用model进行inference，得到pred的文本和原来的groundtruth文本，然后计算metrics，最后返回metrics。
    <br>
    定义了个钩子函数`on_validation_epoch_end`,在validation epoch的最后调用，内部的操作就是使用了log_dict记录了一下metrics，这个log_dict是框架自己定义的一个函数，还没了解透。
    <br>
    `configure_optimizers`函数是训练优化器的所在，画一大段程序算了个没用到的max_iter???不是很懂。然后定义了optimizer使用的是torch现有的库，参数是模型参数，用的是self.parameters()我也没搞懂，不应该是self.model.parameters()吗，还有个参数是lr，比较简单。接着定义了schedule，模式化的东西，是一个字典，里面包含一些关键字，“scheduler”是一个函数，这个函数也是有范式可循，就是学习率怎么调整，指数还是余弦等等。最后返回两个东西，一个是optimizer，一个是schedule，两个都分别放到了一个列表里。
    <br>
    然后就是怎么去写scheduler了，scheduler返回一个LambdaLR的函数，可以去代码里看看是怎么写的，就是定义了一个名为`lr_lambda`的函数用来计算学习率。
    <br>
    `NougatDataPLModule`类继承自`pl.LightningDataModule`，初始化中定义了数据读取。里面有两个改写后的函数`train_dataloader`和`val_dataloader`里面分别有一个loaders的list，至于为什么写我还不知道，先follow吧，list里是一个torch带的DataLoader。
    </li>
</ul>
</font>